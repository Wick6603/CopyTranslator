name: Windows ARM64 Electron Build

on:
  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build_win_arm64:
    name: Build Windows ARM64 App
    
    # âš ï¸ å…³é”®æ­¥éª¤ï¼šä½¿ç”¨ Windows ARM64 è¿è¡Œå™¨
    # æ³¨æ„ï¼šGitHub Actions å…è´¹é¢åº¦å¯èƒ½ä¸åŒ…å« windows-arm64 è¿è¡Œå™¨ã€‚
    # æ‚¨å¯èƒ½éœ€è¦æ˜¯ä¼ä¸šç”¨æˆ·æˆ–ä»˜è´¹ç”¨æˆ·æ‰èƒ½ä½¿ç”¨ã€‚å¦‚æœå¤±è´¥ï¼Œè¯·è”ç³» GitHub æ”¯æŒã€‚
    runs-on: windows-11-arm

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js
        # è®¾ç½® Node.js ç¯å¢ƒï¼Œç‰ˆæœ¬å·è¯·æ ¹æ®é¡¹ç›®éœ€è¦è°ƒæ•´
        uses: actions/setup-node@v4
        with:
          node-version: '16' # ä¿æŒä¸é¡¹ç›®å…¼å®¹çš„ LTS ç‰ˆæœ¬

      - name: ğŸ“¥ Install dependencies
        # å®‰è£…é¡¹ç›®ä¾èµ–ã€‚åœ¨ Windows ä¸Šè¿è¡Œ
        run: npm install

      - name: âš™ï¸ Rebuilding Native Modules (Optional, but recommended for Arm64)
        # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ç¡®ä¿åŸç”Ÿæ¨¡å—ï¼ˆå¦‚ iohook, nut-jsï¼‰é’ˆå¯¹å½“å‰çš„ Electron 8.2.3 / Windows / ARM64 ç¯å¢ƒæ­£ç¡®ç¼–è¯‘
        # ä½¿ç”¨æ‚¨ package.json ä¸­ç±»ä¼¼çš„æ–¹å¼é‡æ–°ç¼–è¯‘ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼Œä½†é€šå¸¸ electron:build ä¼šè§¦å‘ postinstall/install-app-depsï¼‰
        # å¦‚æœ electron:build å‘½ä»¤è¶³å¤Ÿï¼Œå¯ä»¥åˆ é™¤æ­¤æ­¥éª¤
        run: npm rebuild --runtime=electron --target=8.2.3 --disturl=https://atom.io/download/atom-shell --abi=76 --arch=arm64
        # âš ï¸ æ³¨æ„ï¼šå¦‚æœæ‚¨çš„ package.json æœ‰ä¸€ä¸ªä¸“é—¨çš„ arm64 rebuild è„šæœ¬ï¼Œè¯·ä½¿ç”¨å®ƒã€‚

      - name: ğŸ”¨ Run Electron Build
        # æ‰§è¡Œ package.json ä¸­çš„æ„å»ºå‘½ä»¤
        # vue-cli-service electron:build ä¼šè‡ªåŠ¨ä½¿ç”¨ electron-builder
        # é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæœªæŒ‡å®š archï¼Œå®ƒå°†æ ¹æ®è¿è¡Œå™¨æ¶æ„ (arm64) æ„å»ºã€‚
        run: npm run electron:build --loglevel verbose

      - name: ğŸ“¦ Find Build Output Directory
        # æŸ¥æ‰¾ electron-builder çš„é»˜è®¤è¾“å‡ºç›®å½• 'dist_electron'
        id: find_output
        run: |
          $buildDir = "dist_electron"
          if (-not (Test-Path -Path $buildDir -PathType Container)) {
            Write-Host "Default build directory '$buildDir' not found. This might be normal depending on your builder configuration."
          } else {
            Write-Host "::set-output name=output_path::$buildDir"
            Write-Host "Build directory found: $buildDir"
          }
        shell: powershell

      - name: ğŸ“¤ Upload Build Artifacts
        # å°†ç”Ÿæˆçš„æ„å»ºç›®å½•æ‰“åŒ…ä¸ºå¯ä¸‹è½½çš„ Artifact
        uses: actions/upload-artifact@v4
        with:
          # æ‰“åŒ…çš„åç§°å°†åŒ…å«è¿è¡Œå™¨æ¶æ„ï¼Œæ–¹ä¾¿åŒºåˆ†
          name: windows-arm64-build-artifacts
          # æ–‡ä»¶å¤¹è·¯å¾„ã€‚è¿™é‡Œä½¿ç”¨é»˜è®¤çš„ 'dist_electron' ç›®å½•
          path: dist_electron
          retention-days: 7
